<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lab OS Â· Imagination Inventors</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'JetBrains Mono', monospace; }
  </style>
</head>
<body class="bg-black text-green-400">

<header class="border-b border-green-800">
  <div class="px-4 py-3 flex justify-between items-center">
    <div>
      <h1 class="text-sm font-bold">LAB_OS //</h1>
      <p class="text-xs text-green-600">imagination_inventors</p>
    </div>
    <div class="text-xs" id="userLabel"></div>
  </div>
</header>

<main class="px-4 py-4 space-y-6">

  <div>
    <label class="text-xs text-green-600">ACTIVE_PROJECT</label>
    <select id="projectSelect" class="w-full mt-1 px-3 py-2 bg-black border border-green-700 text-green-400"></select>
  </div>

  <div id="projectCard" class="border border-green-800 p-4 space-y-3"></div>

  <div>
    <h2 class="text-xs text-green-600 mb-2">WORK_UNITS</h2>
    <div id="workUnits" class="space-y-3"></div>
  </div>

  <div class="border-t border-green-800 pt-4">
    <h2 class="text-xs text-green-600 mb-2">WEEKLY_SIGNAL</h2>
    <div id="weekly"></div>
  </div>

</main>

<script>
const API = "https://lab-os-backend.onrender.com";
const token = localStorage.getItem("lab_token");
const role = localStorage.getItem("lab_role");
const user = localStorage.getItem("lab_user");
if (!token) location.href = "login.html";
document.getElementById("userLabel").innerText = `${user} [${role}]`;

function headers() { return { Authorization: token, "Content-Type": "application/json" }; }

let projects=[], workUnits=[];

async function loadAll(){
  projects = await fetch(`${API}/projects`,{headers:headers()}).then(r=>r.json());
  workUnits = await fetch(`${API}/work-units`,{headers:headers()}).then(r=>r.json());

  const sel=document.getElementById('projectSelect'); sel.innerHTML='';
  projects.forEach(p=>{const o=document.createElement('option');o.value=p.id;o.textContent=p.name;sel.appendChild(o);});
  sel.onchange=()=>renderProject(projects.find(p=>p.id==sel.value));
  if(projects[0]) renderProject(projects[0]);
  loadWeekly();
}

function renderProject(p){
  const c=document.getElementById('projectCard');
  if(role==='admin'){
    c.innerHTML=`<input id='pn' value='${p.name}' class='w-full bg-black border border-green-700 p-2'>
    <textarea id='pd' class='w-full bg-black border border-green-700 p-2'>${p.description}</textarea>
    <button onclick='saveProject(${p.id})' class='w-full bg-green-600 text-black py-1'>SAVE_PROJECT</button>`;
  } else {
    c.innerHTML=`<h2>${p.name}</h2><p class='text-xs text-green-600'>${p.description}</p>`;
  }
  renderWork(p.id);
}

async function saveProject(id){
  await fetch(`${API}/projects/${id}`,{method:'PUT',headers:headers(),body:JSON.stringify({name:pn.value,description:pd.value})});
  loadAll();
}

function renderWork(pid){
  const c=document.getElementById('workUnits'); c.innerHTML='';
  workUnits.filter(w=>w.project_id===pid).forEach(w=>{
    const d=document.createElement('div');
    d.className=`border p-3 ${w.owner===user?'border-green-500':'border-green-800'}`;
    if(role==='admin'){
      d.innerHTML=`<input value='${w.title}' class='w-full bg-black border border-green-700'>
      <textarea class='w-full bg-black border border-green-700'>${w.description}</textarea>
      <input value='${w.owner}' class='w-full bg-black border border-green-700'>
      <button onclick='saveWork(${w.id},this.parentElement)' class='w-full bg-green-600 text-black'>SAVE_UNIT</button>`;
    } else {
      d.innerHTML=`<div>${w.title}</div><div class='text-xs'>STATUS: ${w.status}</div>`;
    }
    c.appendChild(d);
  });
}

async function saveWork(id,el){
  const i=el.querySelectorAll('input,textarea');
  await fetch(`${API}/work-units/${id}`,{method:'PUT',headers:headers(),body:JSON.stringify({title:i[0].value,description:i[1].value,owner:i[2].value})});
  loadAll();
}

async function loadWeekly(){
  const box=document.getElementById('weekly');
  const res=await fetch(`${API}/weekly-signals`,{headers:headers()});
  const data=await res.json();

  if(role!=='admin'){
    const submitted=data.find(s=>s.user===user);
    if(submitted){box.innerHTML=`<pre>${submitted.moved}\n${submitted.next}\n${submitted.blockers}</pre>`;return;}
    box.innerHTML=`<textarea id='wm' class='w-full bg-black border border-green-700' placeholder='WHAT_MOVED'></textarea>
    <textarea id='wn' class='w-full bg-black border border-green-700' placeholder='WHAT_NEXT'></textarea>
    <textarea id='wb' class='w-full bg-black border border-green-700' placeholder='BLOCKERS'></textarea>
    <button onclick='submitWeekly()' class='w-full bg-green-600 text-black'>SUBMIT_SIGNAL</button>`;
  } else {
    box.innerHTML=data.map(s=>`<pre>[${s.user}]\n${s.moved}\n${s.next}\n${s.blockers}</pre>`).join('');
  }
}

async function submitWeekly(){
  await fetch(`${API}/weekly-signals`,{method:'POST',headers:headers(),body:JSON.stringify({moved:wm.value,next:wn.value,blockers:wb.value})});
  loadWeekly();
}

loadAll();
</script>
</body>
</html>
